<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Chat Widget</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: system-ui, -apple-system, sans-serif;
        background: #0f172a;
        color: #e2e8f0;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }
      h1 {
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
      }
      h1::before {
        content: "";
        width: 8px;
        height: 8px;
        background: #22c55e;
        border-radius: 50%;
      }
      .btn-logout {
        background: transparent;
        border: 1px solid #475569;
        color: #94a3b8;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .btn-logout:hover {
        background: #334155;
        color: #e2e8f0;
        border-color: #64748b;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
      }
      .card {
        background: #1e293b;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #334155;
      }
      .card h2 {
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #94a3b8;
        margin-bottom: 1rem;
      }
      .stat {
        font-size: 2.5rem;
        font-weight: 700;
        color: #f8fafc;
      }
      .stat-label {
        font-size: 0.875rem;
        color: #64748b;
      }
      .list {
        list-style: none;
      }
      .list li {
        padding: 0.75rem;
        background: #0f172a;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        font-family: monospace;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
      }
      .list .origin {
        color: #38bdf8;
      }
      .list .expires {
        color: #64748b;
      }
      .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .badge-green {
        background: #166534;
        color: #86efac;
      }
      .badge-yellow {
        background: #854d0e;
        color: #fde047;
      }
      .empty {
        color: #64748b;
        font-style: italic;
      }

      .form-group {
        margin-bottom: 1rem;
      }
      .form-group label {
        display: block;
        font-size: 0.875rem;
        color: #94a3b8;
        margin-bottom: 0.5rem;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 8px;
        color: #e2e8f0;
        font-size: 0.875rem;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
        font-family: monospace;
      }
      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        font-size: 0.875rem;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #3b82f6;
        color: white;
      }
      .btn-primary:hover {
        background: #2563eb;
      }
      .btn-secondary {
        background: #334155;
        color: #e2e8f0;
      }
      .btn-secondary:hover {
        background: #475569;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #0f172a;
        border-radius: 9999px;
        font-size: 0.875rem;
      }

      .toggle-container {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .toggle {
        position: relative;
        width: 56px;
        min-width: 56px;
        height: 28px;
        cursor: pointer;
        flex-shrink: 0;
      }
      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #334155;
        border-radius: 9999px;
        transition: 0.3s;
      }
      .toggle-slider:before {
        content: "";
        position: absolute;
        width: 22px;
        height: 22px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
      }
      .toggle input:checked + .toggle-slider {
        background: #22c55e;
      }
      .toggle input:checked + .toggle-slider:before {
        transform: translateX(28px);
      }
      .toggle-label {
        font-size: 0.875rem;
        color: #94a3b8;
      }
      .toggle-label.active {
        color: #22c55e;
        font-weight: 500;
      }

      .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
      }
      .alert-warning {
        background: rgba(234, 179, 8, 0.1);
        border: 1px solid #eab308;
        color: #fde047;
      }
      .alert-success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid #22c55e;
        color: #86efac;
      }

      .btn-copy {
        background: #334155;
        border: none;
        color: #94a3b8;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.7rem;
        margin-left: 0.5rem;
      }
      .btn-copy:hover {
        background: #475569;
        color: #e2e8f0;
      }
      .btn-copy.copied {
        background: #166534;
        color: #86efac;
      }

      .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #334155;
        padding-bottom: 1rem;
      }
      .tab {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        color: #94a3b8;
        background: transparent;
        border: none;
      }
      .tab:hover {
        background: #334155;
      }
      .tab.active {
        background: #3b82f6;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* Tools styles */
      .tool-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 1rem !important;
        gap: 1rem;
      }
      .tool-item .tool-info {
        flex: 1;
      }
      .tool-item .tool-name {
        font-weight: 600;
        color: #f8fafc;
      }
      .tool-item .tool-title {
        color: #94a3b8;
        font-size: 0.875rem;
        margin-left: 0.5rem;
      }
      .tool-item .tool-endpoint {
        color: #64748b;
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }
      .tool-item .tool-actions {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
      }
      .tool-item .tool-actions button {
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
      }
      .btn-danger {
        background: #dc2626;
        color: white;
      }
      .btn-danger:hover {
        background: #b91c1c;
      }
      .badge-enabled {
        background: #166534;
        color: #86efac;
      }
      .badge-disabled {
        background: #44403c;
        color: #a8a29e;
      }

      /* Params Builder */
      .param-row {
        display: grid;
        grid-template-columns: 1fr 120px 2fr auto auto;
        gap: 0.5rem;
        align-items: start;
        padding: 0.75rem;
        background: #0f172a;
        border-radius: 8px;
        margin-bottom: 0.5rem;
      }
      .param-row input,
      .param-row select {
        width: 100%;
        padding: 0.5rem;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 6px;
        color: #e2e8f0;
        font-size: 0.8rem;
      }
      .param-row input:focus,
      .param-row select:focus {
        outline: none;
        border-color: #3b82f6;
      }
      .param-row input::placeholder {
        color: #64748b;
      }
      .param-row .required-toggle {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        color: #94a3b8;
        cursor: pointer;
        padding: 0.5rem 0;
      }
      .param-row .required-toggle input {
        width: auto;
        margin: 0;
      }
      .param-row .btn-remove {
        background: transparent;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 0.5rem;
        font-size: 1rem;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .param-row .btn-remove:hover {
        opacity: 1;
      }
      .param-header {
        display: grid;
        grid-template-columns: 1fr 120px 2fr auto auto;
        gap: 0.5rem;
        padding: 0 0.75rem 0.5rem;
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Administrador del Agente</h1>
        <button class="btn-logout" onclick="logout()">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16,17 21,12 16,7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Cerrar sesion
        </button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="config">Configuracion</button>
        <button class="tab" data-tab="embed">Embeber</button>
        <button class="tab" data-tab="training">Entrenamiento</button>
        <button class="tab" data-tab="tools">Herramientas</button>
      </div>

      <!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-content active">
        <div class="grid">
          <div class="card">
            <h2>Sesiones Activas</h2>
            <div class="stat" id="session-count">-</div>
            <div class="stat-label">conexiones actuales</div>
          </div>

          <div class="card">
            <h2>Total Mensajes</h2>
            <div class="stat" id="total-messages">-</div>
            <div class="stat-label">
              <span id="user-messages">-</span> usuario /
              <span id="assistant-messages">-</span> asistente
            </div>
          </div>

          <div class="card">
            <h2>Conversaciones</h2>
            <div class="stat" id="total-sessions">-</div>
            <div class="stat-label">sesiones con mensajes</div>
          </div>

          <div class="card">
            <h2>Costo Total</h2>
            <div class="stat" id="total-cost">-</div>
            <div class="stat-label">
              <span id="total-tokens">-</span> tokens
            </div>
          </div>

          <div class="card">
            <h2>Requests API</h2>
            <div class="stat" id="total-requests">-</div>
            <div class="stat-label">
              latencia prom: <span id="avg-latency">-</span>
            </div>
          </div>

          <div class="card">
            <h2>Modo</h2>
            <div id="mode-badge"></div>
          </div>

          <div class="card" style="grid-column: span 2">
            <h2>Mensajes Ultimos 7 Dias</h2>
            <ul class="list" id="messages-by-day">
              <li class="empty">Cargando...</li>
            </ul>
          </div>

          <div class="card" style="grid-column: span 2">
            <h2>Mensajes por Origen</h2>
            <ul class="list" id="messages-by-origin">
              <li class="empty">Cargando...</li>
            </ul>
          </div>

          <div class="card" style="grid-column: span 2">
            <h2>Uso por Dia (Tokens y Costo)</h2>
            <ul class="list" id="usage-by-day">
              <li class="empty">Cargando...</li>
            </ul>
          </div>

          <div class="card" style="grid-column: span 2">
            <h2>Costo por Origen</h2>
            <ul class="list" id="usage-by-origin">
              <li class="empty">Cargando...</li>
            </ul>
          </div>

          <div class="card" style="grid-column: span 2">
            <h2>Sesiones Activas</h2>
            <ul class="list" id="sessions-list">
              <li class="empty">Cargando...</li>
            </ul>
          </div>

          <div class="card" style="grid-column: span 2">
            <h2>Origenes Permitidos</h2>
            <div id="origins-chips" class="chips"></div>
            <p id="origins-empty" class="empty" style="margin-top: 1rem"></p>
          </div>
        </div>
      </div>

      <!-- Config Tab -->
      <div id="tab-config" class="tab-content">
        <div class="grid">
          <div class="card">
            <h2>Control de Acceso</h2>
            <div id="access-alert"></div>

            <div class="toggle-container" style="margin-bottom: 1.5rem;">
              <label class="toggle">
                <input type="checkbox" id="public-access-toggle" />
                <span class="toggle-slider"></span>
              </label>
              <div>
                <span id="public-access-label" class="toggle-label">Acceso Publico</span>
                <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem;">
                  Cuando esta activo, cualquier sitio web puede usar tu widget (CORS *)
                </p>
              </div>
            </div>

            <a href="/preview" target="_blank" class="btn btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              Preview
            </a>

            <h3
              style="
                font-size: 0.875rem;
                color: #94a3b8;
                margin-bottom: 0.75rem;
              "
            >
              Origenes Permitidos
            </h3>

            <div
              id="env-origins-section"
              style="margin-bottom: 1rem; display: none"
            >
              <label
                style="
                  display: block;
                  font-size: 0.75rem;
                  color: #64748b;
                  margin-bottom: 0.5rem;
                "
              >
                De variables de entorno (solo lectura)
              </label>
              <div id="env-origins-chips" class="chips"></div>
            </div>

            <div id="origins-section">
              <div class="form-group">
                <label
                  style="
                    display: block;
                    font-size: 0.75rem;
                    color: #64748b;
                    margin-bottom: 0.5rem;
                  "
                >
                  Agregar desde el panel
                </label>
                <input
                  type="text"
                  id="new-origin-input"
                  placeholder="midominio.com, otro.com"
                  style="font-family: monospace"
                />
                <p
                  style="color: #64748b; font-size: 0.75rem; margin-top: 0.5rem"
                >
                  Separados por comas. Soporta subdominios automaticamente.
                </p>
              </div>
              <button class="btn btn-primary" id="save-origins-btn">
                Guardar Origenes
              </button>
            </div>
          </div>

          <div class="card">
            <h2>Modelo</h2>
            <div id="model-alert"></div>
            <div class="form-group">
              <label>Selecciona el modelo de IA</label>
              <select id="model-select">
                <option value="gpt-4o-mini">GPT-4o Mini</option>
                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                <option value="gpt-5-nano">GPT-5 Nano (ultra r√°pido)</option>
                <option value="o4-mini">O4 Mini (razonamiento)</option>
              </select>
            </div>
            <button class="btn btn-primary" id="save-model-btn">Guardar Modelo</button>
          </div>

          <div class="card">
            <h2>API Key de OpenAI</h2>
            <div id="apikey-alert"></div>
            <div class="form-group">
              <label>Tu clave de API de OpenAI</label>
              <div style="position: relative">
                <input
                  type="password"
                  id="openai-api-key"
                  placeholder="sk-..."
                  style="font-family: monospace; padding-right: 3rem"
                />
                <button
                  type="button"
                  id="toggle-apikey-visibility"
                  style="
                    position: absolute;
                    right: 0.5rem;
                    top: 50%;
                    transform: translateY(-50%);
                    background: transparent;
                    border: none;
                    color: #64748b;
                    cursor: pointer;
                    padding: 0.25rem;
                  "
                >
                  <svg id="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
              <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.5rem">
                Se guarda encriptada en la base de datos. Puedes obtener una en
                <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #3b82f6">platform.openai.com</a>
              </p>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center">
              <button class="btn btn-primary" id="save-apikey-btn">Guardar API Key</button>
              <span id="apikey-status" style="font-size: 0.75rem; color: #64748b"></span>
            </div>
          </div>

          <div class="card">
            <h2>System Prompt</h2>
            <div class="form-group">
              <label>Plantilla predefinida</label>
              <select disabled>
                <option>Asistente General</option>
                <option>Soporte Tecnico</option>
                <option>Ventas</option>
                <option>FAQ Bot</option>
                <option>Personalizado...</option>
              </select>
            </div>
            <div class="form-group">
              <label>Prompt personalizado</label>
              <textarea
                disabled
                placeholder="Eres un asistente amable que ayuda a los usuarios..."
              ></textarea>
            </div>
            <button class="btn btn-primary" disabled>Guardar Prompt</button>
            <p class="empty" style="margin-top: 1rem">
              Proximamente: edicion de system prompts
            </p>
          </div>
        </div>
      </div>

      <!-- Embed Tab -->
      <div id="tab-embed" class="tab-content">
        <div class="grid">
          <div class="card" style="grid-column: span 2">
            <h2>URL del Servidor</h2>
            <p style="color: #94a3b8; margin-bottom: 1rem">
              URL detectada automaticamente
            </p>
            <div class="form-group">
              <input
                type="url"
                id="server-url"
                value=""
                style="font-size: 1rem; background: #334155; cursor: not-allowed;"
                disabled
              />
            </div>
          </div>

          <div class="card" style="grid-column: span 2">
            <h2>Codigo de Integracion</h2>
            <p style="color: #94a3b8; margin-bottom: 1rem">
              Copia y pega este codigo en tu sitio web, justo antes de
              &lt;/body&gt;
            </p>
            <div class="form-group">
              <div style="position: relative">
                <pre
                  id="embed-code"
                  style="
                    background: #0f172a;
                    padding: 1rem;
                    border-radius: 8px;
                    overflow-x: auto;
                    font-size: 0.8rem;
                    line-height: 1.5;
                    border: 1px solid #334155;
                    white-space: pre-wrap;
                  "
                ></pre>
                <button
                  class="btn btn-primary"
                  id="copy-code-btn"
                  style="
                    position: absolute;
                    top: 0.5rem;
                    right: 0.5rem;
                    padding: 0.5rem 1rem;
                  "
                >
                  Copiar
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Requisitos</h2>
            <ul
              style="
                list-style: disc;
                padding-left: 1.5rem;
                color: #94a3b8;
                line-height: 2;
              "
            >
              <li>
                Tu dominio debe estar en
                <strong style="color: #f8fafc">Origenes Permitidos</strong> o
                activar <strong style="color: #f8fafc">Acceso Publico</strong>
              </li>
              <li>El widget se carga en un iframe seguro</li>
              <li>Cada visitante obtiene una sesion de 2 horas</li>
              <li>El historial se guarda por sesion</li>
            </ul>
          </div>

          <div class="card">
            <h2>Comportamiento</h2>
            <ul
              style="
                list-style: disc;
                padding-left: 1.5rem;
                color: #94a3b8;
                line-height: 2;
              "
            >
              <li>Boton flotante en esquina inferior derecha</li>
              <li>
                Click abre sidebar que
                <strong style="color: #f8fafc">empuja</strong> el contenido
              </li>
              <li>Boton expandir para pantalla completa</li>
              <li>
                API global:
                <code
                  style="
                    background: #334155;
                    padding: 0.2rem 0.4rem;
                    border-radius: 4px;
                  "
                  >ChatWidget.open()</code
                >
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Training Tab -->
      <div id="tab-training" class="tab-content">
        <div class="grid">
          <div class="card">
            <h2>Subir Archivos</h2>
            <label
              class="file-upload"
              style="
                border: 2px dashed #334155;
                border-radius: 8px;
                padding: 1.5rem;
                text-align: center;
                cursor: not-allowed;
                opacity: 0.5;
              "
            >
              <input
                type="file"
                multiple
                accept=".txt,.pdf,.md,.json"
                disabled
                style="display: none"
              />
              <div style="font-size: 1.5rem; margin-bottom: 0.25rem">üìÑ</div>
              <div style="color: #64748b; font-size: 0.75rem">
                .txt .pdf .md .json
              </div>
            </label>
          </div>

          <div class="card">
            <h2>Estado</h2>
            <div class="stat">0</div>
            <div class="stat-label">documentos indexados</div>
            <button
              class="btn btn-secondary"
              style="margin-top: 1rem; width: 100%"
              disabled
            >
              Reindexar
            </button>
          </div>

          <div class="card" style="grid-column: span 2">
            <h2>Base de Conocimiento</h2>
            <ul class="list">
              <li class="empty">No hay documentos cargados</li>
            </ul>
            <p class="empty" style="margin-top: 1rem">
              Proximamente: RAG con embeddings para contexto personalizado
            </p>
          </div>
        </div>
      </div>

      <!-- Tools Tab -->
      <div id="tab-tools" class="tab-content">
        <div class="grid">
          <!-- Formulario de creacion/edicion -->
          <div class="card" style="grid-column: span 2">
            <h2 id="tools-form-title">Nueva Herramienta</h2>
            <div id="tools-alert"></div>

            <form id="tool-form">
              <input type="hidden" id="tool-id" value="" />

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                  <label>Nombre (identificador para AI)*</label>
                  <input type="text" id="tool-name" placeholder="bookCourt" pattern="^[a-zA-Z][a-zA-Z0-9_]*$" required />
                  <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem">
                    Solo letras, numeros y guiones bajos. Ej: getWeather, createBooking
                  </p>
                </div>

                <div class="form-group">
                  <label>Titulo (human-readable)*</label>
                  <input type="text" id="tool-title" placeholder="Reservar Cancha" required />
                </div>
              </div>

              <div class="form-group">
                <label>Descripcion (para el LLM)*</label>
                <textarea id="tool-description" placeholder="Permite reservar una cancha de tenis especificando fecha, hora y tipo de cancha." required style="min-height: 80px;"></textarea>
                <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem">
                  El LLM usara esta descripcion para decidir cuando invocar la herramienta
                </p>
              </div>

              <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                <div class="form-group">
                  <label>URL del Endpoint*</label>
                  <input type="url" id="tool-endpoint" placeholder="https://api.example.com/book" required />
                </div>

                <div class="form-group">
                  <label>Metodo HTTP</label>
                  <select id="tool-method">
                    <option value="POST" selected>POST</option>
                    <option value="GET">GET</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>Headers (JSON)</label>
                <textarea id="tool-headers" placeholder='{
  "Authorization": "Bearer your-api-key",
  "Content-Type": "application/json"
}' style="min-height: 100px; font-family: monospace; font-size: 0.8rem; line-height: 1.4;"></textarea>
                <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem">
                  Headers personalizados para la request. Formato JSON.
                </p>
              </div>

              <div class="form-group">
                <label style="display: flex; justify-content: space-between; align-items: center;">
                  <span>Parametros de Entrada*</span>
                  <button type="button" id="add-param-btn" class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">+ Agregar</button>
                </label>
                <div id="params-builder" style="margin-top: 0.5rem;"></div>
                <p id="no-params-msg" style="color: #64748b; font-size: 0.875rem; padding: 1rem; background: #0f172a; border-radius: 8px; text-align: center;">
                  Sin parametros. Haz clic en "+ Agregar" para definir los datos que el LLM debe recopilar.
                </p>
                <input type="hidden" id="tool-schema" />
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                  <label>Timeout (ms)</label>
                  <input type="number" id="tool-timeout" value="10000" min="1000" max="60000" />
                </div>

                <div class="form-group">
                  <label>URL de Navegacion (opcional)</label>
                  <input type="text" id="tool-navigation" placeholder="/reservas/{{bookingId}}" />
                  <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem">
                    URL para redirigir al usuario despues de ejecutar
                  </p>
                </div>
              </div>

              <div style="display: flex; gap: 1.5rem; margin: 1rem 0;">
                <div class="toggle-container">
                  <label class="toggle">
                    <input type="checkbox" id="tool-enabled" checked />
                    <span class="toggle-slider"></span>
                  </label>
                  <span class="toggle-label">Habilitada</span>
                </div>

                <div class="toggle-container">
                  <label class="toggle">
                    <input type="checkbox" id="tool-confirmation" />
                    <span class="toggle-slider"></span>
                  </label>
                  <span class="toggle-label">Requiere confirmacion</span>
                </div>
              </div>

              <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary" id="tool-submit-btn">Crear Herramienta</button>
                <button type="button" class="btn btn-secondary" id="tool-cancel-btn" style="display: none;">Cancelar</button>
              </div>
            </form>
          </div>

          <!-- Lista de herramientas -->
          <div class="card" style="grid-column: span 2">
            <h2>Herramientas Configuradas</h2>
            <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
              Herramientas disponibles para el agente AI. El LLM puede invocarlas durante la conversacion.
            </p>
            <ul class="list" id="tools-list">
              <li class="empty">Cargando...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Logout - clear Basic Auth credentials
      function logout() {
        // Create XMLHttpRequest with wrong credentials to clear browser cache
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/admin", true, "logout", "logout");
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            // Redirect to admin to trigger new login prompt
            window.location.href = "/admin";
          }
        };
        xhr.send();
      }

      // State
      let currentConfig = { publicAccess: false, allowedOrigins: "" };

      // Tab switching with localStorage persistence
      function switchTab(tabName) {
        document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));
        const tab = document.querySelector(`.tab[data-tab="${tabName}"]`);
        if (tab) {
          tab.classList.add("active");
          document.getElementById("tab-" + tabName).classList.add("active");
          localStorage.setItem("admin_active_tab", tabName);
        }
      }

      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => switchTab(tab.dataset.tab));
      });

      // Restore last active tab
      const savedTab = localStorage.getItem("admin_active_tab");
      if (savedTab) {
        switchTab(savedTab);
      }

      // Copy origin to clipboard
      function copyOrigin(origin, btn) {
        navigator.clipboard.writeText(origin).then(() => {
          btn.textContent = "ok";
          btn.classList.add("copied");
          setTimeout(() => {
            btn.textContent = "cp";
            btn.classList.remove("copied");
          }, 1500);
        });
      }

      // Toggle public access
      document
        .getElementById("public-access-toggle")
        .addEventListener("change", async function () {
          const newValue = this.checked;
          try {
            const res = await fetch("/api/admin/stats"); // dummy check auth
            if (res.status === 401) {
              this.checked = !newValue;
              return;
            }

            const configRes = await fetch("/api/admin/config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ publicAccess: newValue }),
            });

            if (configRes.ok) {
              currentConfig.publicAccess = newValue;
              updateAccessUI();
            } else {
              this.checked = !newValue;
            }
          } catch (err) {
            console.error("Error:", err);
            this.checked = !newValue;
          }
        });

      // Save origins
      document
        .getElementById("save-origins-btn")
        .addEventListener("click", async () => {
          const input = document.getElementById("new-origin-input");
          const origins = input.value;

          try {
            const res = await fetch("/api/admin/config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ allowedOrigins: origins }),
            });

            if (res.ok) {
              currentConfig.allowedOrigins = origins;
              const alertEl = document.getElementById("access-alert");
              alertEl.innerHTML =
                '<div class="alert alert-success">Origenes guardados correctamente</div>';
              setTimeout(() => {
                alertEl.innerHTML = "";
              }, 3000);
              loadStats();
            }
          } catch (err) {
            console.error("Error:", err);
          }
        });

      // Update access UI
      function updateAccessUI() {
        const toggle = document.getElementById("public-access-toggle");
        const label = document.getElementById("public-access-label");
        const section = document.getElementById("origins-section");
        const alertEl = document.getElementById("access-alert");

        toggle.checked = currentConfig.publicAccess;
        label.className =
          "toggle-label" + (currentConfig.publicAccess ? " active" : "");

        if (currentConfig.publicAccess) {
          section.style.opacity = "0.5";
          section.style.pointerEvents = "none";
          alertEl.innerHTML =
            '<div class="alert alert-success">Modo publico activo - cualquier sitio puede usar el widget</div>';
        } else {
          section.style.opacity = "1";
          section.style.pointerEvents = "auto";
          alertEl.innerHTML = "";
        }
      }

      // Load stats
      async function loadStats() {
        try {
          const res = await fetch("/api/admin/stats");
          if (res.status === 401) {
            document.body.innerHTML =
              '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#ef4444;">No autorizado. Recarga la pagina.</div>';
            return;
          }
          const data = await res.json();

          document.getElementById("session-count").textContent =
            data.activeSessions;

          // Config
          if (data.config) {
            currentConfig = data.config;
            document.getElementById("public-access-toggle").checked =
              data.config.publicAccess;
            document.getElementById("new-origin-input").value =
              data.config.allowedOrigins || "";
            updateAccessUI();

            // Show env origins
            const envSection = document.getElementById("env-origins-section");
            const envChips = document.getElementById("env-origins-chips");
            if (data.envOrigins && data.envOrigins.length > 0) {
              envSection.style.display = "block";
              envChips.innerHTML = data.envOrigins
                .map(
                  (o) =>
                    `<span class="chip" style="background: #1e3a5f; border: 1px solid #3b82f6;">${o} <span style="opacity: 0.5; font-size: 0.7rem;">ENV</span></span>`
                )
                .join("");
            } else {
              envSection.style.display = "none";
            }
          }

          // Message stats
          if (data.messages) {
            document.getElementById("total-messages").textContent =
              data.messages.totalMessages || 0;
            document.getElementById("user-messages").textContent =
              data.messages.userMessages || 0;
            document.getElementById("assistant-messages").textContent =
              data.messages.assistantMessages || 0;
            document.getElementById("total-sessions").textContent =
              data.messages.totalSessions || 0;
          }

          // Usage stats
          if (data.usage) {
            const costUsd = (data.usage.totalCostMicro || 0) / 1000000;
            document.getElementById("total-cost").textContent =
              "$" + costUsd.toFixed(4);
            document.getElementById("total-tokens").textContent = (
              data.usage.totalTokens || 0
            ).toLocaleString();
            document.getElementById("total-requests").textContent =
              data.usage.totalRequests || 0;
            document.getElementById("avg-latency").textContent =
              Math.round(data.usage.avgLatencyMs || 0) + "ms";

            // Usage by day
            const usageByDayEl = document.getElementById("usage-by-day");
            if (data.usage.byDay && data.usage.byDay.length > 0) {
              usageByDayEl.innerHTML = data.usage.byDay
                .map((d) => {
                  const cost = (d.costMicro || 0) / 1000000;
                  return `<li><span class="origin">${
                    d.day
                  }</span><span class="expires">${(
                    d.tokens || 0
                  ).toLocaleString()} tokens / $${cost.toFixed(4)} / ${
                    d.requests
                  } reqs / ${Math.round(d.avgLatency || 0)}ms</span></li>`;
                })
                .join("");
            } else {
              usageByDayEl.innerHTML =
                '<li class="empty">Sin datos de uso esta semana</li>';
            }

            // Usage by origin
            const usageByOriginEl = document.getElementById("usage-by-origin");
            if (data.usage.byOrigin && data.usage.byOrigin.length > 0) {
              usageByOriginEl.innerHTML = data.usage.byOrigin
                .map((o) => {
                  const cost = (o.costMicro || 0) / 1000000;
                  return `<li><span class="origin">${
                    o.origin
                  }</span><span class="expires">$${cost.toFixed(4)} / ${(
                    o.tokens || 0
                  ).toLocaleString()} tokens / ${o.requests} reqs</span></li>`;
                })
                .join("");
            } else {
              usageByOriginEl.innerHTML =
                '<li class="empty">Sin datos de uso por origen</li>';
            }
          }

          // Messages by day
          const byDayEl = document.getElementById("messages-by-day");
          if (
            data.messages &&
            data.messages.byDay &&
            data.messages.byDay.length > 0
          ) {
            byDayEl.innerHTML = data.messages.byDay
              .map(
                (d) =>
                  `<li><span class="origin">${d.day}</span><span class="expires">${d.count} msgs / ${d.sessions} sesiones</span></li>`
              )
              .join("");
          } else {
            byDayEl.innerHTML =
              '<li class="empty">Sin mensajes esta semana</li>';
          }

          // Messages by origin
          const byOriginEl = document.getElementById("messages-by-origin");
          if (
            data.messages &&
            data.messages.byOrigin &&
            data.messages.byOrigin.length > 0
          ) {
            byOriginEl.innerHTML = data.messages.byOrigin
              .map(
                (o) =>
                  `<li><span class="origin">${o.origin}</span><span class="expires">${o.messageCount} msgs / ${o.sessionCount} sesiones</span></li>`
              )
              .join("");
          } else {
            byOriginEl.innerHTML =
              '<li class="empty">Sin mensajes por origen</li>';
          }

          // Mode badge
          const modeEl = document.getElementById("mode-badge");
          modeEl.innerHTML = data.isDev
            ? '<span class="badge badge-yellow">Desarrollo</span>'
            : '<span class="badge badge-green">Produccion</span>';

          // API key status
          updateApiKeyStatus(data.hasApiKey, data.apiKeySource);

          // Model select
          const modelSelect = document.getElementById("model-select");
          if (data.model) {
            modelSelect.value = data.model;
          }

          // Sessions list
          const listEl = document.getElementById("sessions-list");
          if (data.sessions.length === 0) {
            listEl.innerHTML = '<li class="empty">No hay sesiones activas</li>';
          } else {
            listEl.innerHTML = data.sessions
              .map(
                (s) =>
                  `<li><span class="origin">${s.origin}</span><span class="expires">${s.expiresIn} <button class="btn-copy" data-origin="${s.origin}" title="Copiar origen">cp</button></span></li>`
              )
              .join("");

            // Add click handlers for copy buttons
            listEl.querySelectorAll(".btn-copy").forEach((btn) => {
              btn.addEventListener("click", () =>
                copyOrigin(btn.dataset.origin, btn)
              );
            });
          }

          // Origins chips
          const chipsEl = document.getElementById("origins-chips");
          const emptyEl = document.getElementById("origins-empty");
          if (data.allowedOrigins.length === 0) {
            chipsEl.innerHTML = "";
            emptyEl.textContent = data.isDev
              ? "Modo desarrollo: todos los origenes permitidos"
              : "No hay origenes configurados.";
          } else {
            chipsEl.innerHTML = data.allowedOrigins
              .map((o) => `<span class="chip">${o}</span>`)
              .join("");
            emptyEl.textContent = "";
          }
        } catch (err) {
          console.error("Error loading stats:", err);
        }
      }

      // Generate embed code
      function generateEmbedCode() {
        const input = document.getElementById("server-url");
        const serverUrl = input.value.trim() || window.location.origin;
        const code = `<!-- Chat Widget -->\n<script src="${serverUrl}/embed.js"><\/script>`;
        document.getElementById("embed-code").textContent = code;
      }

      // Server URL input (auto-detected, disabled)
      document.getElementById("server-url").value = window.location.origin;

      // Copy code button
      document.getElementById("copy-code-btn").addEventListener("click", () => {
        const code = document.getElementById("embed-code").textContent;
        navigator.clipboard.writeText(code).then(() => {
          const btn = document.getElementById("copy-code-btn");
          btn.textContent = "Copiado!";
          setTimeout(() => {
            btn.textContent = "Copiar";
          }, 2000);
        });
      });

      // Save model
      document
        .getElementById("save-model-btn")
        .addEventListener("click", async () => {
          const select = document.getElementById("model-select");
          const model = select.value;
          const alertEl = document.getElementById("model-alert");

          try {
            const res = await fetch("/api/admin/config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ model }),
            });

            if (res.ok) {
              alertEl.innerHTML = '<div class="alert alert-success">Modelo guardado correctamente</div>';
              setTimeout(() => { alertEl.innerHTML = ""; }, 3000);
            } else {
              alertEl.innerHTML = '<div class="alert alert-warning">Error al guardar</div>';
              setTimeout(() => { alertEl.innerHTML = ""; }, 3000);
            }
          } catch (err) {
            console.error("Error:", err);
            alertEl.innerHTML = '<div class="alert alert-warning">Error de conexion</div>';
            setTimeout(() => { alertEl.innerHTML = ""; }, 3000);
          }
        });

      // Toggle API key visibility
      document
        .getElementById("toggle-apikey-visibility")
        .addEventListener("click", () => {
          const input = document.getElementById("openai-api-key");
          const icon = document.getElementById("eye-icon");
          if (input.type === "password") {
            input.type = "text";
            icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
          } else {
            input.type = "password";
            icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
          }
        });

      // Save API key
      document
        .getElementById("save-apikey-btn")
        .addEventListener("click", async () => {
          const input = document.getElementById("openai-api-key");
          const apiKey = input.value.trim();
          const alertEl = document.getElementById("apikey-alert");

          if (!apiKey) {
            alertEl.innerHTML = '<div class="alert alert-warning">Ingresa una API key</div>';
            setTimeout(() => { alertEl.innerHTML = ""; }, 3000);
            return;
          }

          if (!apiKey.startsWith("sk-")) {
            alertEl.innerHTML = '<div class="alert alert-warning">La API key debe comenzar con sk-</div>';
            setTimeout(() => { alertEl.innerHTML = ""; }, 3000);
            return;
          }

          try {
            const res = await fetch("/api/admin/config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ openaiApiKey: apiKey }),
            });

            if (res.ok) {
              alertEl.innerHTML = '<div class="alert alert-success">API Key guardada correctamente</div>';
              input.value = "";
              updateApiKeyStatus(true, "db");
              setTimeout(() => { alertEl.innerHTML = ""; }, 3000);
            } else {
              alertEl.innerHTML = '<div class="alert alert-warning">Error al guardar</div>';
              setTimeout(() => { alertEl.innerHTML = ""; }, 3000);
            }
          } catch (err) {
            console.error("Error:", err);
            alertEl.innerHTML = '<div class="alert alert-warning">Error de conexion</div>';
            setTimeout(() => { alertEl.innerHTML = ""; }, 3000);
          }
        });

      // Update API key status indicator
      function updateApiKeyStatus(hasKey, source) {
        const statusEl = document.getElementById("apikey-status");
        if (hasKey && source === "db") {
          statusEl.innerHTML = '<span class="chip" style="background: #166534; color: #86efac;">sk-******* <span style="opacity: 0.7; font-size: 0.7rem;">DB</span></span>';
        } else if (hasKey && source === "env") {
          statusEl.innerHTML = '<span class="chip" style="background: #1e3a5f; border: 1px solid #3b82f6;">sk-******* <span style="opacity: 0.7; font-size: 0.7rem;">ENV</span></span>';
        } else {
          statusEl.innerHTML = '<span style="color: #ef4444;">‚óè No configurada</span>';
        }
      }

      // Initial load
      loadStats();
      generateEmbedCode();
      setInterval(loadStats, 10000);

      // ============ TOOLS MANAGEMENT ============

      let editingToolId = null;
      let toolsCache = [];
      let paramsData = []; // Visual params builder data

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Show alert in tools tab
      function showToolAlert(message, type) {
        const alertEl = document.getElementById("tools-alert");
        alertEl.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
        setTimeout(() => { alertEl.innerHTML = ""; }, 4000);
      }

      // Validate JSON
      function isValidJson(str) {
        if (!str || !str.trim()) return true;
        try {
          JSON.parse(str);
          return true;
        } catch {
          return false;
        }
      }

      // ============ PARAMS BUILDER ============

      function renderParamsBuilder() {
        const container = document.getElementById("params-builder");
        const noParamsMsg = document.getElementById("no-params-msg");

        if (paramsData.length === 0) {
          container.innerHTML = "";
          noParamsMsg.style.display = "block";
          return;
        }

        noParamsMsg.style.display = "none";

        let html = `<div class="param-header">
          <span>Nombre</span>
          <span>Tipo</span>
          <span>Descripcion</span>
          <span>Req.</span>
          <span></span>
        </div>`;

        paramsData.forEach((param, index) => {
          html += `
            <div class="param-row" data-index="${index}">
              <input type="text" class="param-name" placeholder="fecha" value="${escapeHtml(param.name || "")}" />
              <select class="param-type">
                <option value="string" ${param.type === "string" ? "selected" : ""}>string</option>
                <option value="number" ${param.type === "number" ? "selected" : ""}>number</option>
                <option value="boolean" ${param.type === "boolean" ? "selected" : ""}>boolean</option>
                <option value="integer" ${param.type === "integer" ? "selected" : ""}>integer</option>
              </select>
              <input type="text" class="param-desc" placeholder="Fecha en formato YYYY-MM-DD" value="${escapeHtml(param.description || "")}" />
              <label class="required-toggle">
                <input type="checkbox" class="param-required" ${param.required ? "checked" : ""} />
              </label>
              <button type="button" class="btn-remove" onclick="removeParam(${index})">√ó</button>
            </div>
          `;
        });

        container.innerHTML = html;

        // Add event listeners
        container.querySelectorAll(".param-row").forEach((row) => {
          const index = parseInt(row.dataset.index);
          row.querySelector(".param-name").addEventListener("input", (e) => {
            paramsData[index].name = e.target.value;
            updateSchemaFromParams();
          });
          row.querySelector(".param-type").addEventListener("change", (e) => {
            paramsData[index].type = e.target.value;
            updateSchemaFromParams();
          });
          row.querySelector(".param-desc").addEventListener("input", (e) => {
            paramsData[index].description = e.target.value;
            updateSchemaFromParams();
          });
          row.querySelector(".param-required").addEventListener("change", (e) => {
            paramsData[index].required = e.target.checked;
            updateSchemaFromParams();
          });
        });
      }

      function addParam() {
        paramsData.push({ name: "", type: "string", description: "", required: true });
        renderParamsBuilder();
        // Focus the new row's name input
        const rows = document.querySelectorAll(".param-row");
        if (rows.length > 0) {
          rows[rows.length - 1].querySelector(".param-name").focus();
        }
      }

      function removeParam(index) {
        paramsData.splice(index, 1);
        renderParamsBuilder();
        updateSchemaFromParams();
      }

      function updateSchemaFromParams() {
        const validParams = paramsData.filter(p => p.name && p.name.trim());
        if (validParams.length === 0) {
          document.getElementById("tool-schema").value = "";
          return;
        }

        const schema = {
          type: "object",
          properties: {},
          required: []
        };

        validParams.forEach(p => {
          const name = p.name.trim();
          schema.properties[name] = {
            type: p.type,
            description: p.description || undefined
          };
          if (p.required) {
            schema.required.push(name);
          }
        });

        if (schema.required.length === 0) {
          delete schema.required;
        }

        document.getElementById("tool-schema").value = JSON.stringify(schema, null, 2);
      }

      function loadParamsFromSchema(schemaJson) {
        paramsData = [];
        if (!schemaJson) {
          renderParamsBuilder();
          return;
        }

        try {
          const schema = JSON.parse(schemaJson);
          if (schema.properties) {
            const required = schema.required || [];
            for (const [name, prop] of Object.entries(schema.properties)) {
              paramsData.push({
                name,
                type: prop.type || "string",
                description: prop.description || "",
                required: required.includes(name)
              });
            }
          }
        } catch (e) {
          console.error("Error parsing schema:", e);
        }

        renderParamsBuilder();
      }

      // Add param button
      document.getElementById("add-param-btn").addEventListener("click", addParam);

      // Format JSON in headers textarea on blur
      document.getElementById("tool-headers").addEventListener("blur", function() {
        if (this.value.trim()) {
          try {
            const parsed = JSON.parse(this.value);
            this.value = JSON.stringify(parsed, null, 2);
          } catch (e) {
            // Invalid JSON, leave as is
          }
        }
      });

      // Load tools list
      async function loadTools() {
        try {
          const res = await fetch("/api/admin/tools", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ intent: "list" }),
          });
          if (res.status === 401) return;
          const data = await res.json();
          toolsCache = data.tools || [];

          const listEl = document.getElementById("tools-list");
          if (toolsCache.length === 0) {
            listEl.innerHTML = '<li class="empty">No hay herramientas configuradas. Crea una usando el formulario de arriba.</li>';
            return;
          }

          listEl.innerHTML = toolsCache.map(tool => `
            <li class="tool-item">
              <div class="tool-info">
                <div>
                  <span class="tool-name">${escapeHtml(tool.name)}</span>
                  <span class="tool-title">- ${escapeHtml(tool.title)}</span>
                  <span class="badge ${tool.enabled ? 'badge-enabled' : 'badge-disabled'}" style="margin-left: 0.5rem;">
                    ${tool.enabled ? 'Activa' : 'Inactiva'}
                  </span>
                </div>
                <div class="tool-endpoint">${tool.httpMethod} ${escapeHtml(tool.endpointUrl)}</div>
              </div>
              <div class="tool-actions">
                <button class="btn btn-secondary" onclick="editTool('${tool.id}')">Editar</button>
                <button class="btn btn-danger" onclick="deleteToolConfirm('${tool.id}')">Eliminar</button>
              </div>
            </li>
          `).join("");
        } catch (err) {
          console.error("Error loading tools:", err);
        }
      }

      // Edit tool - load into form
      function editTool(id) {
        const tool = toolsCache.find(t => t.id === id);
        if (!tool) {
          alert("Herramienta no encontrada");
          return;
        }

        editingToolId = id;
        document.getElementById("tool-id").value = id;
        document.getElementById("tool-name").value = tool.name;
        document.getElementById("tool-title").value = tool.title;
        document.getElementById("tool-description").value = tool.description;
        document.getElementById("tool-endpoint").value = tool.endpointUrl;
        document.getElementById("tool-method").value = tool.httpMethod || "POST";

        // Format headers JSON
        const headers = tool.headersJson || "";
        try {
          document.getElementById("tool-headers").value = headers ? JSON.stringify(JSON.parse(headers), null, 2) : "";
        } catch {
          document.getElementById("tool-headers").value = headers;
        }

        // Load schema into params builder
        document.getElementById("tool-schema").value = tool.inputSchemaJson || "";
        loadParamsFromSchema(tool.inputSchemaJson);

        document.getElementById("tool-timeout").value = tool.timeoutMs || 10000;
        document.getElementById("tool-navigation").value = tool.navigationUrl || "";
        document.getElementById("tool-enabled").checked = tool.enabled;
        document.getElementById("tool-confirmation").checked = tool.requiresConfirmation;

        document.getElementById("tools-form-title").textContent = "Editar Herramienta";
        document.getElementById("tool-submit-btn").textContent = "Guardar Cambios";
        document.getElementById("tool-cancel-btn").style.display = "inline-block";

        document.getElementById("tab-tools").scrollIntoView({ behavior: "smooth" });
      }

      // Cancel edit - reset form
      function cancelToolEdit() {
        editingToolId = null;
        document.getElementById("tool-form").reset();
        document.getElementById("tool-id").value = "";
        document.getElementById("tool-enabled").checked = true;
        document.getElementById("tools-form-title").textContent = "Nueva Herramienta";
        document.getElementById("tool-submit-btn").textContent = "Crear Herramienta";
        document.getElementById("tool-cancel-btn").style.display = "none";

        // Clear params builder
        paramsData = [];
        renderParamsBuilder();
      }

      // Delete tool with confirmation
      async function deleteToolConfirm(id) {
        const tool = toolsCache.find(t => t.id === id);
        if (!confirm(`Seguro que deseas eliminar la herramienta "${tool?.name}"?`)) {
          return;
        }

        try {
          const res = await fetch("/api/admin/tools", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ intent: "delete", id }),
          });

          if (res.ok) {
            showToolAlert("Herramienta eliminada correctamente", "success");
            loadTools();
            if (editingToolId === id) {
              cancelToolEdit();
            }
          } else {
            const data = await res.json();
            showToolAlert(data.error || "Error al eliminar", "warning");
          }
        } catch (err) {
          console.error("Error deleting tool:", err);
          showToolAlert("Error de conexion", "warning");
        }
      }

      // Form submission
      document.getElementById("tool-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("tool-name").value.trim();
        const title = document.getElementById("tool-title").value.trim();
        const description = document.getElementById("tool-description").value.trim();
        const endpointUrl = document.getElementById("tool-endpoint").value.trim();
        const httpMethod = document.getElementById("tool-method").value;
        const headersJson = document.getElementById("tool-headers").value.trim();
        const inputSchemaJson = document.getElementById("tool-schema").value.trim();
        const timeoutMs = parseInt(document.getElementById("tool-timeout").value) || 10000;
        const navigationUrl = document.getElementById("tool-navigation").value.trim();
        const enabled = document.getElementById("tool-enabled").checked;
        const requiresConfirmation = document.getElementById("tool-confirmation").checked;

        // Validations
        if (!name || !title || !description || !endpointUrl) {
          showToolAlert("Completa todos los campos requeridos (*)", "warning");
          return;
        }

        // Check if at least one param with name exists
        const validParams = paramsData.filter(p => p.name && p.name.trim());
        if (validParams.length === 0) {
          showToolAlert("Agrega al menos un parametro de entrada", "warning");
          return;
        }

        if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(name)) {
          showToolAlert("El nombre debe comenzar con letra y solo contener letras, numeros y _", "warning");
          return;
        }

        if (headersJson && !isValidJson(headersJson)) {
          showToolAlert("Los Headers no son JSON valido", "warning");
          return;
        }

        const isEdit = !!editingToolId;
        const payload = {
          intent: isEdit ? "update" : "create",
          id: editingToolId,
          name,
          title,
          description,
          endpointUrl,
          httpMethod,
          headersJson: headersJson || null,
          inputSchemaJson,
          timeoutMs,
          navigationUrl: navigationUrl || null,
          enabled,
          requiresConfirmation,
        };

        try {
          const res = await fetch("/api/admin/tools", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await res.json();

          if (res.ok) {
            showToolAlert(isEdit ? "Herramienta actualizada correctamente" : "Herramienta creada correctamente", "success");
            cancelToolEdit();
            loadTools();
          } else {
            showToolAlert(data.error || "Error al guardar", "warning");
          }
        } catch (err) {
          console.error("Error saving tool:", err);
          showToolAlert("Error de conexion", "warning");
        }
      });

      // Cancel button handler
      document.getElementById("tool-cancel-btn").addEventListener("click", cancelToolEdit);

      // Load tools when switching to tools tab
      document.querySelector('.tab[data-tab="tools"]').addEventListener("click", loadTools);

      // Initial load if tools tab is active
      if (localStorage.getItem("admin_active_tab") === "tools") {
        loadTools();
      }

      // Initialize params builder on load
      renderParamsBuilder();
    </script>
  </body>
</html>
